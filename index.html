<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nahwu - BAIM</title>
    <style>
        /* --- RESET & BASIC STYLE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f0fdf4; color: #333; display: flex; justify-content: center; min-height: 100vh; overscroll-behavior-y: none; }
        
        /* --- LOADING SCREEN --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3; border-top: 4px solid #16a34a;
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- MOBILE CONTAINER FRAME --- */
        #app-container {
            width: 100%; max-width: 480px; background: white;
            position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; height: 100vh; height: 100dvh; overflow: hidden;
        }

        /* --- LAYAR LOGIN --- */
        #login-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #16a34a, #15803d);
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; padding: 30px; text-align: center; color: white;
        }
        .logo-area { margin-bottom: 50px; }
        .logo-area h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .logo-area p { font-size: 1.1rem; opacity: 0.9; }

        .btn-google {
            background: white; color: #555; padding: 12px 25px;
            border-radius: 50px; border: none; font-weight: 600; font-size: 1rem;
            display: flex; align-items: center; gap: 12px;
            cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        .btn-google:active { transform: scale(0.95); }
        .google-icon-svg { width: 24px; height: 24px; }

        /* --- DASHBOARD AREA --- */
        #dashboard-screen { display: none; flex-direction: column; height: 100%; }

        header {
            position: fixed; top: 0; width: 100%; max-width: 480px;
            padding: 15px 20px; background: white; border-bottom: 2px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center; z-index: 1001;
        }

        .premium-badge { background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; display: none; }
        .btn-gear { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; }

        main {
            flex: 1; overflow-y: auto; padding: 20px; background: #f8fafc;
            padding-top: 90px; padding-bottom: 100px;
        }

        .page-section { display: none; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }
        
        .level-card {
            background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px;
            border-bottom: 4px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .level-card:active { transform: translateY(2px); border-bottom: 2px solid #cbd5e1; }

        .level-info h3 { margin-bottom: 5px; color: #15803d; }
        .level-info p { font-size: 0.9rem; color: #64748b; }

        /* --- TAMPILAN TERKUNCI --- */
        .level-card.locked-mode {
            background-color: #f8fafc !important; border-bottom-color: #cbd5e1 !important; position: relative;
        }
        .level-card.locked-mode h3, .level-card.locked-mode p, .level-card.locked-mode div { color: #94a3b8 !important; }
        .level-card.locked-mode .lock-icon { color: #ef4444 !important; display: inline-block !important; margin-left: 5px; }
        .level-card.locked-mode .btn-play { background: #cbd5e1 !important; border-bottom-color: #94a3b8 !important; color: #64748b !important; }
        .level-card.locked-mode div[style*="font-size: 2.5rem"] { filter: grayscale(100%); opacity: 0.5; }        

        .btn-play {
            background: #16a34a; color: white; border: none; padding: 10px 20px;
            border-radius: 10px; font-weight: bold; border-bottom: 4px solid #14532d; cursor: pointer;
        }
        .btn-play:active { border-bottom: 0; transform: translateY(4px); }

        /* --- LEADERBOARD STYLE --- */
        .podium-container { display: flex; justify-content: center; align-items: flex-end; gap: 10px; margin-bottom: 20px; padding-top: 10px; }
        .podium-item { text-align: center; width: 30%; display: flex; flex-direction: column; align-items: center; }
        
        .avatar-circle { 
            width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.2rem; color: #555; background: #f1f5f9; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative; margin-bottom: 5px;
        }
        
        /* Juara 1 */
        .rank-1 .avatar-circle { width: 70px; height: 70px; background: #fffbeb; border-color: #fbbf24; color: #d97706; font-size: 1.8rem; z-index: 2; }
        .rank-1 .p-name { font-weight: bold; color: #d97706; }
        
        /* Juara 2 & 3 */
        .rank-2 .avatar-circle { border-color: #94a3b8; background: #f8fafc; color: #64748b; }
        .rank-3 .avatar-circle { border-color: #fdba74; background: #fff7ed; color: #c2410c; }
        
        .p-name { font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .p-xp { font-size: 0.75rem; color: #94a3b8; }

        /* List Peringkat */
        .rank-list-item { 
            display: flex; align-items: center; background: white; padding: 12px; 
            border-radius: 12px; margin-bottom: 8px; border: 1px solid #f1f5f9; 
        }
        .rank-list-item.me { border: 2px solid #2563eb; background: #eff6ff; }
        
        .r-num { font-weight: bold; width: 30px; text-align: center; color: #64748b; }
        .r-info { flex: 1; margin-left: 10px; }
        .r-xp { font-weight: bold; color: #f59e0b; }

        /* --- NAVBAR --- */
        nav {
            position: fixed; bottom: 0; width: 100%; max-width: 480px;
            background: white; border-top: 1px solid #e5e7eb;
            display: flex; justify-content: space-around; padding: 10px 0;
            z-index: 1000; padding-bottom: env(safe-area-inset-bottom, 10px);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; cursor: pointer; font-size: 0.8rem; background: none; border: none; }
        .nav-item span { font-size: 1.5rem; margin-bottom: 2px; }
        .nav-item.active { color: #16a34a; font-weight: bold; }

        /* --- PROFILE --- */
        .profile-header { text-align: center; margin-bottom: 20px; }
        .avatar-container { width: 80px; height: 80px; margin: 0 auto 15px auto; background: #dcfce7; border-radius: 50%; padding: 10px; display: flex; justify-content: center; align-items: center; }
        .avatar-svg { width: 100%; height: 100%; fill: #16a34a; }
        .btn-logout { width: 100%; padding: 15px; background: #ef4444; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px;}

        /* --- SETTINGS --- */
        .setting-item { background: white; padding: 15px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #16a34a; }
        input:checked + .slider:before { transform: translateX(24px); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="spinner"></div>
    <p style="color: #666; font-size: 0.9rem;">Memuat data...</p>
</div>

<div id="app-container">
    
    <div id="login-screen">
        <div class="logo-area">
            <h1>üïå BAIM</h1>
            <p>Bahasa Arab Itu Mudah</p>
        </div>
        <button id="btnLogin" class="btn-google">
            <svg class="google-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                <path fill="#34A853" d="M24 48c6.48 0 12.23-2.57 16.43-6.43l-7.73-6c-2.15 1.45-4.92 2.3-8.7 2.3-6.26 0-11.57-4.22-13.46-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
            </svg>
            Masuk dengan Google
        </button>
    </div>

    <div id="dashboard-screen">
        <header>
            <div id="userDisplayName" style="font-weight: bold; font-size: 0.9rem;">Halo, User</div>
            <div style="display: flex; align-items: center; gap:10px;">
                <span id="badgePremium" class="premium-badge">PREMIUM</span>
                <button class="btn-gear" onclick="gantiHalaman('settings', this)">‚öôÔ∏è</button>
            </div>
        </header>

        <main>
            <div id="page-home" class="page-section active">
                <h2 style="margin-bottom: 20px; color: #166534;">Menu Utama</h2>
                
                <div id="card-pemula" class="level-card btn-effect" onclick="cekAkses('dl.html', true)" style="cursor: pointer;">
                    <div style="display:flex; align-items:center; gap: 15px;">
                        <div style="font-size: 2.5rem;">üìñ</div> 
                        <div class="level-info">
                            <h3 style="margin:0;">Pemula <span class="lock-icon" style="display:none;">üîí</span></h3>
                            <p style="margin:0; font-size:0.85rem; color:#666;">Durusul Lughah</p>
                        </div>
                    </div>
                    <button class="btn-play">Mulai</button>
                </div>

                <div id="card-lanjutan" class="level-card btn-effect" onclick="cekAkses('nahwu.html', true)" style="cursor: pointer;">
                    <div style="display:flex; align-items:center; gap: 15px;">
                        <div style="font-size: 2.5rem;">üöÄ</div> 
                        <div class="level-info">
                            <h3 style="margin:0;">Lanjutan <span class="lock-icon" style="display:none;">üîí</span></h3>
                            <p style="margin:0; font-size:0.85rem; color:#666;">Ilmu Nahwu</p>
                        </div>
                    </div>
                    <button class="btn-play">Mulai</button>
                </div>

                <div class="level-card btn-effect" onclick="cekAkses('tugas.html', false)" style="cursor: pointer;">
                    <div style="display:flex; align-items:center; gap: 15px;">
                        <div style="font-size: 2.5rem;">üìù</div> 
                        <div class="level-info">
                            <h3 style="margin:0;">Tugas & Latihan</h3>
                            <p style="margin:0; font-size:0.85rem; color:#666;">Evaluasi Harian</p>
                        </div>
                    </div>
                    <button class="btn-play" style="background:#f59e0b; border-bottom:4px solid #b45309;">Buka</button>
                </div>

                <div id="card-kosakata" class="level-card btn-effect" onclick="cekAkses('kosakata.html', true)" 
                     style="cursor: pointer; background: #faf5ff; border-bottom: 4px solid #d8b4fe;">
                    <div style="display:flex; align-items:center; gap: 15px;">
                        <div style="font-size: 2.5rem;">üéÆ</div> 
                        <div class="level-info">
                            <h3 style="margin:0; color: #7e22ce;">Kosakata <span class="lock-icon" style="display:none;">üîí</span></h3>
                            <p style="margin:0; font-size:0.85rem; color:#6b7280;">Game Hafalan</p>
                        </div>
                    </div>
                    <button class="btn-play" style="background: #9333ea; border-bottom: 4px solid #6b21a8;">Main</button>
                </div>
            </div>

            <div id="page-leaderboard" class="page-section" style="padding-bottom: 80px;">
                <h2 style="margin-bottom: 15px; color: #1e293b;">Papan Peringkat</h2>
                
                <div id="podium-area" class="podium-container">
                    <div style="text-align:center; width:100%; color:#94a3b8;">Memuat data...</div>
                </div>

                <div id="rank-list-area"></div>
            </div>

            <div id="page-profile" class="page-section">
                <div class="profile-header">
                    <div class="avatar-container">
                        <svg class="avatar-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" /></svg>
                    </div>
                    <div id="name-display" style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 5px;">
                        <h2 id="profileName" style="margin: 0;">Nama User</h2>
                        <button onclick="modeEditNama()" class="btn-effect" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">‚úèÔ∏è</button>
                    </div>
                    <div id="name-edit" style="display: none; margin-bottom: 10px;">
                        <input type="text" id="inputNewName" placeholder="Nama baru..." style="padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 60%;">
                        <button onclick="simpanNamaBaru()" class="btn-effect" style="padding: 8px 15px; background: #16a34a; color: white; border: none; border-radius: 5px;">üíæ</button>
                        <button onclick="batalEditNama()" class="btn-effect" style="padding: 8px 10px; background: #ef4444; color: white; border: none; border-radius: 5px;">‚ùå</button>
                    </div>
                    
                    <p id="profileEmail" style="color:#666; font-size: 0.9rem;">user@email.com</p>

                    <div class="profile-stats" style="display: flex; gap: 15px; margin-top: 20px;">
                        <div style="flex: 1; background: #f0fdf4; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #dcfce7;">
                            <span style="font-size: 1.5rem;">üèÜ</span>
                            <p style="font-size: 0.8rem; color: #666;">Level Nahwu</p>
                            <h3 id="display-level">-</h3>
                        </div>
                        <div style="flex: 1; background: #fffbeb; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #fef3c7;">
                            <span style="font-size: 1.5rem;">‚ö°</span>
                            <p style="font-size: 0.8rem; color: #666;">Total Skor XP</p>
                            <h3 id="display-xp">0</h3>
                        </div>
                    </div>

                    <div style="margin-top: 10px;">
                        <span id="badgeProfile" style="background:#e2e8f0; padding:5px 15px; border-radius:20px; font-size:0.8rem; font-weight: bold; color: #475569;">Free Member</span>
                    </div>
                </div>
                <button id="btnLogout" class="btn-logout btn-effect">Keluar Akun</button>
            </div>

            <div id="page-settings" class="page-section">
                <h2 style="margin-bottom: 20px;">Pengaturan ‚öôÔ∏è</h2>
                
                <div class="setting-item">
                    <span>üîä Efek Suara</span>
                    <label class="switch">
                        <input type="checkbox" id="toggleSound" onchange="updateSetting('sound')" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <span>üì≥ Efek Getar</span>
                    <label class="switch">
                        <input type="checkbox" id="toggleVibration" onchange="updateSetting('vibrate')" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div style="margin-top: 30px; padding: 15px; background: #fffbe6; border-radius: 10px; font-size: 0.85rem; color: #b45309;">
                    <p>üí° <b>Info:</b> Pengaturan ini disimpan di HP ini. Getar mungkin tidak berfungsi di beberapa perangkat iOS/iPhone.</p>
                </div>
                
                <button onclick="gantiHalaman('home', document.querySelector('.nav-item'))" class="btn-effect" style="margin-top: 20px; padding: 10px 20px; background: #333; color: white; border: none; border-radius: 8px; width: 100%;">Kembali ke Menu Utama</button>
            </div>
        </main>

        <nav>
            <button class="nav-item active" onclick="gantiHalaman('home', this)"><span>üè†</span> Belajar</button>
            <button class="nav-item" onclick="gantiHalaman('leaderboard', this)"><span>üèÜ</span> Peringkat</button>
            <button class="nav-item" onclick="gantiHalaman('profile', this)"><span>üë§</span> Profil</button>
        </nav>
    </div>

</div>

<script type="module">
    // 1. IMPORT HARUS DI PALING ATAS
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // 2. Variabel Global Status Premium
    let statusMemberPremium = false;

    // CONFIG FIREBASE ANDA
    const firebaseConfig = {
        apiKey: "AIzaSyA1RESzQo4srN6R3rxLABv8Xw4menYsuJg",
        authDomain: "durusul-lughoh-online.firebaseapp.com",
        projectId: "durusul-lughoh-online",
        storageBucket: "durusul-lughoh-online.firebasestorage.app",
        messagingSenderId: "260425044938",
        appId: "1:260425044938:web:88d956d2cac35331887533",
        measurementId: "G-8NR5K1NKPH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // --- LOGIC UI ---
    const loadingScreen = document.getElementById('loading-screen');
    const loginScreen = document.getElementById('login-screen');
    const dashboardScreen = document.getElementById('dashboard-screen');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');

    // Login & Logout
    btnLogin.addEventListener('click', () => { signInWithPopup(auth, provider).catch(console.error); });
    btnLogout.addEventListener('click', () => { signOut(auth).then(() => window.location.reload()); });

    // Auth State Listener
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // A. Update UI Dasar
            document.getElementById('userDisplayName').innerText = "Ahlan, " + (user.displayName ? user.displayName.split(" ")[0] : "User");
            document.getElementById('profileName').innerText = user.displayName;
            document.getElementById('profileEmail').innerText = user.email;

            // B. Ambil Data Database
            const userRef = doc(db, "users", user.uid);
            let docSnap = await getDoc(userRef);

            // C. Jika User Baru (Belum ada di DB), Buat dulu
            if (!docSnap.exists()) {
                await setDoc(userRef, { 
                    email: user.email, 
                    nama: user.displayName, 
                    isPremium: false, 
                    premiumExpired: null,
                    nahwu_progress: 1,
                    dl_progress: 1,
                    tugas_progress: 1,
                    total_xp: 0
                });
                docSnap = await getDoc(userRef); 
            }

            const data = docSnap.data();

            // D. Tampilkan XP & Level
            if(document.getElementById('display-level')) document.getElementById('display-level').innerText = data.nahwu_progress || 1;
            if(document.getElementById('display-xp')) document.getElementById('display-xp').innerText = data.total_xp || 0;

            // E. CEK STATUS PREMIUM (LOGIKA UTAMA & VISUAL)
            const now = new Date();
            const expired = data.premiumExpired ? new Date(data.premiumExpired) : null;
            
            // Daftar ID Kartu yang Premium
            const premiumCards = ['card-pemula', 'card-lanjutan', 'card-kosakata'];

            if (data.isPremium && expired > now) {
                // --- USER PREMIUM ---
                statusMemberPremium = true;
                
                document.getElementById('badgePremium').style.display = 'inline-block';
                document.getElementById('badgeProfile').innerText = "Premium Member";
                document.getElementById('badgeProfile').style.background = "gold";
                document.getElementById('badgeProfile').style.color = "#713f12";

                // Buka Kunci Visual (Hapus class locked-mode)
                premiumCards.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.remove('locked-mode');
                });
                document.querySelectorAll('.lock-icon').forEach(el => el.style.display = 'none');

            } else {
                // --- USER GRATISAN ---
                statusMemberPremium = false;
                
                document.getElementById('badgePremium').style.display = 'none';
                document.getElementById('badgeProfile').innerText = "Free Member";
                document.getElementById('badgeProfile').style.background = "#e2e8f0";
                document.getElementById('badgeProfile').style.color = "#475569";

                // Kunci Visual (Tambah class locked-mode)
                premiumCards.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.add('locked-mode');
                });
            }

            // F. Tampilkan Dashboard
            loginScreen.style.display = 'none';
            dashboardScreen.style.display = 'flex';
        } else {
            dashboardScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
        }
        
        loadingScreen.style.display = 'none';
    });

    // --- FUNGSI GATEKEEPER (PENGECEK AKSES) ---
    window.cekAkses = function(url, wajibPremium) {
        if (!wajibPremium) {
            window.location.href = url;
            return;
        }

        if (statusMemberPremium) {
            window.location.href = url;
        } else {
            Swal.fire({
                title: 'Konten Premium üîí',
                html: `Maaf, materi ini khusus member Premium.<br>Silakan upgrade akun antum.`,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Info Upgrade',
                cancelButtonText: 'Nanti',
                confirmButtonColor: '#16a34a'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire('Fitur Upgrade', 'Hubungi Admin via WhatsApp untuk upgrade.', 'success');
                }
            });
        }
    }

    // --- NAVIGASI HALAMAN (SPA) ---
    window.gantiHalaman = function(pageId, btnElement) {
        document.querySelectorAll('.page-section').forEach(el => el.style.display = 'none');
        document.getElementById('page-' + pageId).style.display = 'block';

        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');

        // JIKA MASUK KE LEADERBOARD -> LOAD DATA
        if (pageId === 'leaderboard') {
            loadLeaderboard();
        }
    }

    // --- FUNGSI LOAD LEADERBOARD ---
    async function loadLeaderboard() {
      const podiumArea = document.getElementById('podium-area');
      const listArea = document.getElementById('rank-list-area');
      const myUid = auth.currentUser ? auth.currentUser.uid : null;

      try {
          const q = query(collection(db, "users"), orderBy("total_xp", "desc"), limit(50));
          const snap = await getDocs(q);
          
          const users = [];
          snap.forEach(doc => users.push({ id: doc.id, ...doc.data() }));

          if (users.length === 0) {
              podiumArea.innerHTML = "Belum ada data.";
              listArea.innerHTML = "";
              return;
          }

          // RENDER PODIUM (2-1-3)
          let podiumHtml = '';
          if(users[1]) podiumHtml += makePodiumHtml(users[1], 2);
          else podiumHtml += '<div class="podium-item"></div>'; 
          
          if(users[0]) podiumHtml += makePodiumHtml(users[0], 1);
          
          if(users[2]) podiumHtml += makePodiumHtml(users[2], 3);
          
          podiumArea.innerHTML = podiumHtml;

          // RENDER LIST (4+)
          let listHtml = '';
          for (let i = 3; i < users.length; i++) {
              const u = users[i];
              const isMe = (u.id === myUid) ? 'me' : '';
              const nama = u.nama || "User";
              
              listHtml += `
                <div class="rank-list-item ${isMe}">
                    <div class="r-num">${i+1}</div>
                    <div class="avatar-circle" style="width:35px; height:35px; font-size:0.8rem; margin:0; background:#f1f5f9; border:none;">
                        ${nama.charAt(0).toUpperCase()}
                    </div>
                    <div class="r-info">
                        <div style="font-weight:600; font-size:0.9rem;">${nama}</div>
                        <div style="font-size:0.75rem; color:#94a3b8;">Level ${u.nahwu_progress||1}</div>
                    </div>
                    <div class="r-xp">${u.total_xp||0} XP</div>
                </div>`;
          }
          listArea.innerHTML = listHtml;

      } catch (error) {
          console.error(error);
          if(error.message.includes("index")) {
              podiumArea.innerHTML = `<a href="#" style="color:red; font-size:0.7rem;">Admin: Klik Link di Console (F12) untuk buat Index</a>`;
          }
      }
    }

    function makePodiumHtml(u, rank) {
        const nama = (u.nama || "User").split(" ")[0];
        return `
          <div class="podium-item rank-${rank}">
              <div class="avatar-circle">${nama.charAt(0).toUpperCase()}</div>
              <div class="p-name">${nama}</div>
              <div class="p-xp">${u.total_xp||0} XP</div>
          </div>`;
    }

    // --- FITUR GANTI NAMA ---
    window.modeEditNama = function() {
        const currentName = document.getElementById('profileName').innerText;
        document.getElementById('inputNewName').value = currentName;
        document.getElementById('name-display').style.display = 'none';
        document.getElementById('name-edit').style.display = 'block';   
    }

    window.batalEditNama = function() {
        document.getElementById('name-display').style.display = 'flex';
        document.getElementById('name-edit').style.display = 'none';
    }

    window.simpanNamaBaru = async function() {
        const newName = document.getElementById('inputNewName').value;
        const user = auth.currentUser;

        if (newName.trim() === "") { alert("Nama tidak boleh kosong!"); return; }

        const btnSimpan = document.querySelector('#name-edit button');
        btnSimpan.innerText = "...";

        try {
            await updateProfile(user, { displayName: newName });
            const userRef = doc(db, "users", user.uid);
            await updateDoc(userRef, { nama: newName });

            document.getElementById('profileName').innerText = newName;
            document.getElementById('userDisplayName').innerText = "Ahlan, " + newName.split(" ")[0];
            
            alert("Nama berhasil diubah!");
            batalEditNama(); 

        } catch (error) {
            console.error("Gagal update nama:", error);
            alert("Gagal mengubah nama. Coba lagi.");
        } finally {
            btnSimpan.innerText = "üíæ"; 
        }
    }

    // --- FITUR SUARA & GETAR ---
    const soundPop = new Audio("audio/pop.mp3");
    
    let isSoundOn = localStorage.getItem('pref_sound') !== 'false'; 
    let isVibrateOn = localStorage.getItem('pref_vibrate') !== 'false'; 

    if(document.getElementById('toggleSound')) document.getElementById('toggleSound').checked = isSoundOn;
    if(document.getElementById('toggleVibration')) document.getElementById('toggleVibration').checked = isVibrateOn;

    window.updateSetting = function(type) {
        if (type === 'sound') {
            isSoundOn = document.getElementById('toggleSound').checked;
            localStorage.setItem('pref_sound', isSoundOn);
            if(isSoundOn) soundPop.play(); 
        } else if (type === 'vibrate') {
            isVibrateOn = document.getElementById('toggleVibration').checked;
            localStorage.setItem('pref_vibrate', isVibrateOn);
            if(isVibrateOn && navigator.vibrate) navigator.vibrate(50); 
        }
    }

    // Global Listener Efek Klik
    document.addEventListener('click', function(e) {
        if (
            e.target.tagName === 'BUTTON' || 
            e.target.classList.contains('nav-item') ||
            e.target.classList.contains('level-card') ||
            e.target.classList.contains('btn-effect') ||
            e.target.closest('.level-card') || 
            e.target.closest('.nav-item')
        ) {
            mainkanEfek();
        }
    });

    function mainkanEfek() {
        if (isSoundOn) {
            soundPop.currentTime = 0; 
            soundPop.play().catch(e => {});
        }
        if (isVibrateOn && navigator.vibrate) {
            navigator.vibrate(50);
        }
    }
</script>

</body>
</html>
