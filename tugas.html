<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tugas & Latihan</title>
    <style>
        /* --- STYLE DASAR --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #fff7ed; /* Warna oranye muda */ color: #333; display: flex; justify-content: center; min-height: 100vh; }
        
        #app-container {
            width: 100%; max-width: 480px; background: white;
            position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; height: 100vh; height: 100dvh;
        }

        header {
            padding: 15px 20px; background: white; border-bottom: 1px solid #fed7aa;
            display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 100;
        }
        .btn-back { background: none; border: none; font-size: 1.5rem; cursor: pointer; }

        /* --- AREA PETA PANJANG --- */
        #map-area {
            flex: 1; overflow-y: auto; position: relative; background: #fffaf5;
            scrollbar-width: none; opacity: 0; transition: opacity 0.5s; padding-top: 20px;
            padding-bottom: 50px; /* Ruang ekstra di bawah */
        }
        #map-area.ready { opacity: 1; }
        #map-area::-webkit-scrollbar { display: none; }
        
        /* Garis Jalur Ular */
        #path-svg { position: absolute; top: 0; left: 0; width: 100%; z-index: 0; pointer-events: none; }

        /* NODE STYLE */
        .map-node {
            width: 60px; height: 60px; position: absolute; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.1rem; font-weight: bold; cursor: pointer; z-index: 2;
            transition: transform 0.2s;
            background: #e2e8f0; color: #94a3b8; box-shadow: 0 4px 0 #cbd5e1;
        }
        .map-node:active { transform: scale(0.9); }

        /* STATUS LEVEL */
        .map-node.completed { background: #fbbf24; color: #ffffff; box-shadow: 0 4px 0 #d97706; }
        .check-icon { font-size: 1.8rem; font-weight: 900; }

        /* Level AKTIF (Oranye) */
        .map-node.active { 
            background: #f97316; color: white; box-shadow: 0 4px 0 #c2410c; 
            animation: pulse 2s infinite; z-index: 3; font-family: 'Segoe UI', sans-serif; font-size: 1.4rem;
        }

        .map-node.locked { background: #e2e8f0; color: #94a3b8; box-shadow: 0 4px 0 #cbd5e1; opacity: 1; }

        .level-label {
            position: absolute; background: white; padding: 3px 8px; border-radius: 6px;
            font-size: 0.75rem; width: 90px; text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); pointer-events: none;
            z-index: 10; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; color: #475569;
        }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }

        /* MODAL POPUP */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 2000;
            display: none; justify-content: center; align-items: center; animation: fadeIn 0.2s;
        }
        #modal-box {
            background: white; width: 85%; max-width: 320px; padding: 25px; border-radius: 20px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: scale(0.8); opacity: 0; transition: all 0.3s;
        }
        #modal-overlay.show #modal-box { transform: scale(1); opacity: 1; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-modal { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-primary { background: #f97316; color: white; box-shadow: 0 4px 0 #c2410c; }
        .btn-secondary { background: #f1f5f9; color: #64748b; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="app-container">
    <header>
        <button class="btn-back" onclick="window.location.href='index.html'">‚¨ÖÔ∏è</button>
        <h2 style="margin:0; font-size: 1.2rem;">Tugas & Latihan</h2>
    </header>

    <div id="map-area">
        <svg id="path-svg"></svg>
        <div id="nodes-container"></div>
    </div>
</div>

<div id="modal-overlay">
    <div id="modal-box">
        <span id="m-icon" style="font-size:3rem; display:block; margin-bottom:10px;">üîí</span>
        <h3 id="m-title" style="margin-bottom:10px;">Judul</h3>
        <p id="m-desc" style="color:#666; font-size:0.9rem;">Deskripsi</p>
        <div id="m-actions" class="modal-btns"></div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA1RESzQo4srN6R3rxLABv8Xw4menYsuJg",
    authDomain: "durusul-lughoh-online.firebaseapp.com",
    projectId: "durusul-lughoh-online",
    storageBucket: "durusul-lughoh-online.firebasestorage.app",
    messagingSenderId: "260425044938",
    appId: "1:260425044938:web:88d956d2cac35331887533",
    measurementId: "G-8NR5K1NKPH"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentTugasProgress = 1; 
  
  // --- DATA LEVEL (1-40) ---
  const levels = [];
  for(let i=1; i<=40; i++) {
      levels.push({ id: i, title: "Tugas " + i });
  }
  
  // Tidak ada levelGroups lagi, semua ditampilkan langsung

  onAuthStateChanged(auth, async (user) => {
    if (user) {
        const userRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(userRef);
        
        currentTugasProgress = (docSnap.exists() && docSnap.data().tugas_progress) ? docSnap.data().tugas_progress : 1;
        
        renderSnakeMap(); // Langsung render semua
        
    } else {
        window.location.href = 'index.html';
    }
  });

  function renderSnakeMap() {
      const container = document.getElementById('nodes-container');
      const svgEl = document.getElementById('path-svg');
      const mapArea = document.getElementById('map-area');
      
      container.innerHTML = ''; 

      // Render SEMUA level (1-40)
      const filteredLevels = levels; 

      const nodeSize = 60; const cols = 3; const rowHeight = 120;
      const contentWidth = Math.min(mapArea.offsetWidth || window.innerWidth, 480);
      const colWidth = contentWidth / cols;

      let nodesHtml = ''; let pathPoints = [];

      filteredLevels.forEach((level, index) => {
          const row = Math.floor(index / cols);
          let col = (row % 2 === 0) ? (index % cols) : ((cols - 1) - (index % cols));
          
          const posX = (col * colWidth) + (colWidth / 2) - (nodeSize / 2);
          const posY = 30 + (row * rowHeight);
          pathPoints.push({ x: posX + (nodeSize/2), y: posY + (nodeSize/2) });

          let statusClass = 'locked'; let content = 'üîí'; let statusData = 'locked';

          if (level.id < currentTugasProgress) {
              statusClass = 'completed'; content = '<span class="check-icon">‚úî</span>'; statusData = 'completed';
          } else if (level.id === currentTugasProgress) {
              statusClass = 'active'; content = level.id; statusData = 'active';
          }

          nodesHtml += `
            <div id="node-${level.id}" class="map-node ${statusClass}" data-status="${statusData}" 
                 style="left: ${posX}px; top: ${posY}px;" onclick="handlePopup(${level.id})">
                ${content}
            </div>
            <div class="level-label" style="left: ${posX - 15}px; top: ${posY + 65}px;">${level.title}</div>
          `;
      });

      // Hitung tinggi total agar bisa discroll panjang
      const totalHeight = 50 + (Math.ceil(filteredLevels.length / cols) * rowHeight) + 50;
      
      container.style.height = totalHeight + "px";
      svgEl.style.height = totalHeight + "px";
      container.innerHTML = nodesHtml;

      drawSnakePath(pathPoints);
      
      mapArea.classList.remove('ready');
      setTimeout(() => mapArea.classList.add('ready'), 50);
      
      // Auto Scroll ke Level Aktif (Agak delay biar render selesai)
      setTimeout(() => {
          const activeNode = document.querySelector('.map-node.active');
          if(activeNode) {
              activeNode.scrollIntoView({behavior: "smooth", block: "center"});
          }
      }, 500);
  }

  function drawSnakePath(points) {
      if (points.length < 2) { document.getElementById('path-svg').innerHTML = ''; return; }
      let pathD = `M ${points[0].x} ${points[0].y}`;
      for (let i = 1; i < points.length; i++) pathD += ` L ${points[i].x} ${points[i].y}`;
      document.getElementById('path-svg').innerHTML = `<path d="${pathD}" stroke="#cbd5e1" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round" />`;
  }

  window.handlePopup = function(id) {
      const levelData = levels.find(L => L.id === id);
      const title = levelData ? levelData.title : "Tugas " + id;
      const el = document.getElementById(`node-${id}`);
      const status = el ? el.dataset.status : 'locked';

      showModal(status, id, title);
  }

  function showModal(status, id, title) {
      const overlay = document.getElementById('modal-overlay');
      const icon = document.getElementById('m-icon');
      const tit = document.getElementById('m-title');
      const desc = document.getElementById('m-desc');
      const actions = document.getElementById('m-actions');

      actions.innerHTML = '';

      if (status === 'locked') {
          icon.innerHTML = 'üîí'; tit.innerText = 'Terkunci';
          desc.innerText = `Selesaikan tugas sebelumnya.`;
          actions.innerHTML = `<button class="btn-modal btn-secondary" onclick="closeModal()">Oke</button>`;
      } 
      else if (status === 'active') {
          icon.innerHTML = 'üìù'; tit.innerText = `${title}`;
          desc.innerText = `Siap mengerjakan latihan?`;
          
          // Mengarah ke 'gametugas.html'
          actions.innerHTML = `
            <button class="btn-modal btn-secondary" onclick="closeModal()">Nanti</button>
            <button class="btn-modal btn-primary" onclick="window.location.href='gametugas.html?level=${id}'">Mulai</button>`;
      } 
      else if (status === 'completed') {
          icon.innerHTML = '‚Ü∫'; tit.innerText = 'Selesai';
          desc.innerText = `Kerjakan ulang?`;
          
          actions.innerHTML = `
            <button class="btn-modal btn-secondary" onclick="closeModal()">Tutup</button>
            <button class="btn-modal btn-primary" style="background:#fbbf24; color:#78350f;" onclick="window.location.href='gametugas.html?level=${id}'">Ulangi</button>`;
      }

      overlay.style.display = 'flex';
      setTimeout(() => overlay.classList.add('show'), 10);
  }

  window.closeModal = function() {
      const overlay = document.getElementById('modal-overlay');
      overlay.classList.remove('show');
      setTimeout(() => { overlay.style.display = 'none'; }, 200);
  }

  const soundPop = new Audio("audio/pop.mp3"); 
  const isSoundOn = localStorage.getItem('pref_sound') !== 'false';
  document.addEventListener('click', (e) => {
      if ((e.target.closest('.map-node') || e.target.closest('.btn-back') || e.target.closest('.btn-modal')) && isSoundOn) {
          soundPop.currentTime = 0; soundPop.play().catch(()=>{});
      }
  });
</script>

</body>
</html>
