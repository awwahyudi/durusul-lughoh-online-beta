<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bermain - Durusul Lughah</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* --- STYLE DASAR (Konsisten dengan App) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #f0f9ff; color: #333; display: flex; justify-content: center; min-height: 100vh; overflow: hidden; }
        
        #app-container {
            width: 100%; max-width: 480px; background: white;
            display: flex; flex-direction: column; height: 100vh; height: 100dvh;
            position: relative;
        }

        /* HEADER */
        header { padding: 15px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #bfdbfe; background: #f0f9ff; }
        .btn-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; }
        .progress-container { flex: 1; height: 12px; background: #e2e8f0; border-radius: 10px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: #2563eb; transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* AREA KONTEN */
        main { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; align-items: center; }
        
        /* MEDIA WRAPPER */
        .media-wrapper { width: 100%; margin-bottom: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .q-image { max-width: 100%; max-height: 200px; border-radius: 12px; border: 2px solid #f1f5f9; object-fit: contain; }
        .video-container { width: 100%; position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .audio-control-box { width: 100%; background: #f0f9ff; border: 2px solid #bae6fd; padding: 15px; border-radius: 15px; text-align: center; }
        .btn-replay { background: #0284c7; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }

        /* PERTANYAAN */
        .question-text { font-size: 1.25rem; font-weight: bold; margin-bottom: 25px; line-height: 1.4; text-align: center; color: #1e293b; width: 100%; }

        /* OPSI JAWABAN */
        #options-area { width: 100%; display: flex; flex-direction: column; gap: 12px; }
        .opt-btn { padding: 16px 20px; border: 2px solid #e2e8f0; border-radius: 16px; background: white; font-size: 1.1rem; cursor: pointer; text-align: left; transition: all 0.2s; font-weight: 600; box-shadow: 0 4px 0 #e2e8f0; width: 100%; }
        .opt-btn.selected { border-color: #2563eb; background: #eff6ff; color: #2563eb; transform: translateY(2px); box-shadow: 0 2px 0 #2563eb; }

        /* FOOTER */
        footer { padding: 20px; border-top: 1px solid #e2e8f0; background: white; width: 100%; }
        #btn-check { width: 100%; padding: 16px; border: none; border-radius: 16px; background: #2563eb; color: white; font-weight: bold; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 0 #1e40af; display: none; }

        /* --- UPDATE TIPE SOAL SUSUN KATA (ARABIC STYLE) --- */
        .answer-area { 
            min-height: 80px; 
            border-bottom: 2px dashed #cbd5e1; 
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            padding: 10px; 
            justify-content: center; 
            width: 100%; 
            
            /* INI KUNCINYA AGAR KANAN KE KIRI */
            direction: rtl; 
            background-color: #f8fafc;
            border-radius: 12px;
        }

        .word-bank { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        
        .word-chip { 
            padding: 10px 18px; 
            background: white; 
            border: 2px solid #e2e8f0; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: bold; 
            box-shadow: 0 3px 0 #e2e8f0; 
            
            /* FONT ARAB LEBIH BAGUS */
            font-family: "Traditional Arabic", "Scheherazade New", serif; 
            font-size: 1.5rem; 
            line-height: 1;
        }
        
        .word-chip.used { opacity: 0.3; cursor: default; transform: scale(0.95); box-shadow: none; }
        
        /* MATCHING STYLE */
        .pair-container { display: flex; gap: 10px; width: 100%; }
        .pair-column { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .pair-item { padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; text-align: center; cursor: pointer; background: white; font-weight: bold; }
        .pair-item.selected { border-color: #2563eb; background: #eff6ff; color: #2563eb; }
        .pair-item.matched { visibility: hidden; pointer-events: none; }
    </style>
</head>
<body>

<div id="app-container">
    <header>
        <button class="btn-close" onclick="keluarGame()">âœ•</button>
        <div class="progress-container">
            <div id="progress-bar"></div>
        </div>
        <div id="xp-display" style="font-weight: bold; color: #f59e0b;">âš¡ 0</div>
    </header>

    <main id="game-content">
        <div id="media-wrapper" class="media-wrapper"></div>
        <div id="question-text" class="question-text"></div>
        <div id="options-area"></div>
    </main>

    <footer>
        <button id="btn-check" onclick="prosesJawaban()">PERIKSA</button>
    </footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA1RESzQo4srN6R3rxLABv8Xw4menYsuJg",
        authDomain: "durusul-lughoh-online.firebaseapp.com",
        projectId: "durusul-lughoh-online",
        storageBucket: "durusul-lughoh-online.firebasestorage.app",
        messagingSenderId: "260425044938",
        appId: "1:260425044938:web:88d956d2cac35331887533",
        measurementId: "G-8NR5K1NKPH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const levelId = parseInt(urlParams.get('level')) || 1;
    const DB_FIELD = 'dl_progress'; 
    const BACK_LINK = 'dl.html';

    const databaseSoal = {
        level_1: [
            // 1. SINGLE CHOICE + GAMBAR
            { 
                tipe: "pilih_satu",
                gambar: "https://cdn-icons-png.flaticon.com/512/3389/3389081.png", 
                tanya: "Apa bahasa Arab untuk benda di gambar ini?",
                opsi: ["ÙƒÙØªÙŽØ§Ø¨ÙŒ (Kitabun)", "Ù‚ÙŽÙ„ÙŽÙ…ÙŒ (Qalamun)", "Ù…ÙŽÙƒÙ’ØªÙŽØ¨ÙŒ (Maktabun)"],
                kunci: "ÙƒÙØªÙŽØ§Ø¨ÙŒ (Kitabun)"
            },
            // 2. BENAR SALAH
            { 
                tipe: "benar_salah",
                gambar: "https://cdn-icons-png.flaticon.com/512/2921/2921226.png", 
                tanya: "Gambar di atas menunjukkan contoh ISIM (Kata Benda).",
                kunci: false 
            },
            // 3. AUDIO CHOICE
            { 
                tipe: "pilih_satu",
                audio: "audio/babun.mp3",
                tanya: "Dengarkan! Apa arti dari kata yang diucapkan?",
                opsi: ["Pintu", "Jendela", "Dinding"],
                kunci: "Pintu"
            },
            // 4. SUSUN KATA (ARABIC STYLE - RTL)
            { 
                tipe: "susun_kata",
                gambar: "https://cdn-icons-png.flaticon.com/512/1995/1995539.png",
                tanya: "Susun kalimat: 'Guru itu sedang berdiri'",
                // Perhatikan urutan di kunci: [Kanan, Kiri]
                opsi: ["Ø§Ù„Ù’Ù…ÙØ¯ÙŽØ±ÙÙ‘Ø³Ù", "ÙˆÙŽØ§Ù‚ÙÙÙŒ"],
                kunci: ["Ø§Ù„Ù’Ù…ÙØ¯ÙŽØ±ÙÙ‘Ø³Ù", "ÙˆÙŽØ§Ù‚ÙÙÙŒ"] 
            },
            // 5. MATCHING
            { 
                tipe: "pasangan",
                tanya: "Jodohkan kata berikut dengan artinya:",
                kiri: ["Ø³ÙŽÙ…ÙŽØ§Ø¡ÙŒ", "Ø£ÙŽØ±Ù’Ø¶ÙŒ"],
                kanan: ["Bumi", "Langit"],
                kunci: { "Ø³ÙŽÙ…ÙŽØ§Ø¡ÙŒ": "Langit", "Ø£ÙŽØ±Ù’Ø¶ÙŒ": "Bumi" }
            }
        ]
    };

    let soalSekarang = 0; let xpDidapat = 0; let skorPerSoal = 5; let isReplay = false;
    let pilihanUser = null; let currentUser = null; let activeAudio = null;

    const daftarSoal = databaseSoal[`level_${levelId}`] || [];

    const sfxPop = new Audio("audio/pop.mp3");
    const sfxBenar = new Audio("audio/benar.mp3");
    const sfxError = new Audio("audio/error.mp3");
    const sfxSelesai = new Audio("audio/selesai.mp3");
    const isSoundOn = localStorage.getItem('pref_sound') !== 'false';

    function playSfx(type) {
        if (!isSoundOn) return;
        if (type === 'pop') { sfxPop.currentTime=0; sfxPop.play().catch(()=>{}); }
        if (type === 'benar') sfxBenar.play();
        if (type === 'error') sfxError.play();
        if (type === 'selesai') sfxSelesai.play();
    }

    onAuthStateChanged(auth, async (user) => { 
        if (user) {
            currentUser = user;
            const ref = doc(db, "users", user.uid);
            const snap = await getDoc(ref);
            if (snap.exists()) {
                const prog = snap.data()[DB_FIELD] || 1; 
                if (levelId < prog) { isReplay = true; skorPerSoal = 2; }
            }
            muatSoal(); 
        } else { window.location.href = 'index.html'; }
    });

    window.muatSoal = function() {
        if (soalSekarang >= daftarSoal.length) { levelSelesai(); return; }
        const data = daftarSoal[soalSekarang];

        const mediaWrap = document.getElementById('media-wrapper');
        mediaWrap.innerHTML = ''; 
        if(activeAudio) { activeAudio.pause(); activeAudio = null; }

        if (data.gambar) mediaWrap.innerHTML += `<img src="${data.gambar}" class="q-image" alt="Soal">`;
        if (data.audio) {
            activeAudio = new Audio(data.audio);
            mediaWrap.innerHTML += `<div class="audio-control-box"><button class="btn-replay" onclick="putarAudioSoal()">ðŸ”Š Dengarkan</button></div>`;
            activeAudio.play().catch(()=>{});
        }

        document.getElementById('question-text').innerText = data.tanya || "";
        const area = document.getElementById('options-area');
        area.innerHTML = ''; pilihanUser = null;
        document.getElementById('btn-check').style.display = 'none';

        if (data.tipe === "pilih_satu") renderPilihSatu(data);
        else if (data.tipe === "pilih_banyak") renderPilihBanyak(data);
        else if (data.tipe === "benar_salah") renderBenarSalah(data);
        else if (data.tipe === "susun_kata") renderSusunKata(data);
        else if (data.tipe === "pasangan") renderPasangan(data);

        document.getElementById('progress-bar').style.width = (soalSekarang / daftarSoal.length) * 100 + "%";
    }

    window.putarAudioSoal = () => { if (activeAudio) { activeAudio.currentTime = 0; activeAudio.play(); } };

    function renderPilihSatu(data) {
        data.opsi.forEach(teks => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn'; btn.innerText = teks;
            btn.onclick = () => { playSfx('pop'); document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); pilihanUser = teks; document.getElementById('btn-check').style.display = 'block'; };
            document.getElementById('options-area').appendChild(btn);
        });
    }

    function renderBenarSalah(data) {
        [{t:'BENAR', v:true}, {t:'SALAH', v:false}].forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn'; btn.innerText = o.t;
            btn.onclick = () => { playSfx('pop'); document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); pilihanUser = o.v; document.getElementById('btn-check').style.display = 'block'; };
            document.getElementById('options-area').appendChild(btn);
        });
    }

    function renderPilihBanyak(data) {
        pilihanUser = [];
        data.opsi.forEach(teks => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn'; btn.innerText = teks;
            btn.onclick = () => {
                playSfx('pop');
                if(btn.classList.contains('selected')) { btn.classList.remove('selected'); pilihanUser = pilihanUser.filter(i => i !== teks); }
                else { btn.classList.add('selected'); pilihanUser.push(teks); }
                document.getElementById('btn-check').style.display = pilihanUser.length > 0 ? 'block' : 'none';
            };
            document.getElementById('options-area').appendChild(btn);
        });
    }

    function renderSusunKata(data) {
        pilihanUser = [];
        const area = document.getElementById('options-area');
        const ansArea = document.createElement('div'); ansArea.className = 'answer-area';
        const bank = document.createElement('div'); bank.className = 'word-bank';
        data.opsi.forEach(w => {
            const chip = document.createElement('div'); chip.className = 'word-chip'; chip.innerText = w;
            chip.onclick = () => {
                playSfx('pop'); chip.classList.add('used');
                const clone = chip.cloneNode(true); clone.classList.remove('used');
                clone.onclick = () => { playSfx('pop'); chip.classList.remove('used'); clone.remove(); pilihanUser = pilihanUser.filter(x => x !== w); if(pilihanUser.length === 0) document.getElementById('btn-check').style.display='none'; };
                // Karena Direction RTL, appendChild akan menambah dari Kanan ke Kiri secara visual
                ansArea.appendChild(clone); pilihanUser.push(w);
                document.getElementById('btn-check').style.display = 'block';
            };
            bank.appendChild(chip);
        });
        area.appendChild(ansArea); area.appendChild(bank);
    }

    function renderPasangan(data) {
        pilihanUser = { k: null, v: null };
        const area = document.getElementById('options-area');
        const container = document.createElement('div'); container.className = 'pair-container';
        const colL = document.createElement('div'); colL.className = 'pair-column';
        const colR = document.createElement('div'); colR.className = 'pair-column';
        data.kiri.forEach(txt => {
            const item = document.createElement('div'); item.className = 'pair-item'; item.innerText = txt;
            item.onclick = () => { playSfx('pop'); document.querySelectorAll('.pair-column:first-child .pair-item').forEach(i => i.classList.remove('selected')); item.classList.add('selected'); pilihanUser.k = txt; cekPasangan(data); };
            colL.appendChild(item);
        });
        data.kanan.forEach(txt => {
            const item = document.createElement('div'); item.className = 'pair-item'; item.innerText = txt;
            item.onclick = () => { playSfx('pop'); document.querySelectorAll('.pair-column:last-child .pair-item').forEach(i => i.classList.remove('selected')); item.classList.add('selected'); pilihanUser.v = txt; cekPasangan(data); };
            colR.appendChild(item);
        });
        container.appendChild(colL); container.appendChild(colR); area.appendChild(container);
    }
    
    function cekPasangan(data) {
        if (pilihanUser.k && pilihanUser.v) {
            if (data.kunci[pilihanUser.k] === pilihanUser.v) {
                playSfx('pop');
                document.querySelectorAll('.pair-item.selected').forEach(i => { i.classList.add('matched'); i.classList.remove('selected'); });
                pilihanUser = { k: null, v: null };
                if (document.querySelectorAll('.pair-item:not(.matched)').length === 0) { document.getElementById('btn-check').style.display = 'block'; pilihanUser = "DONE"; }
            } else { setTimeout(() => { document.querySelectorAll('.pair-item').forEach(i => i.classList.remove('selected')); pilihanUser = { k: null, v: null }; }, 300); }
        }
    }

    window.prosesJawaban = () => {
        const data = daftarSoal[soalSekarang];
        let benar = false;

        if (data.tipe === "pilih_satu" || data.tipe === "benar_salah") benar = (pilihanUser === data.kunci);
        else if (data.tipe === "pilih_banyak") benar = data.kunci.every(k => pilihanUser.includes(k)) && data.kunci.length === pilihanUser.length;
        else if (data.tipe === "susun_kata") benar = JSON.stringify(pilihanUser) === JSON.stringify(data.kunci);
        else if (data.tipe === "pasangan") benar = (pilihanUser === "DONE");

        if (benar) {
            playSfx('benar'); xpDidapat += skorPerSoal;
            document.getElementById('xp-display').innerText = "âš¡ " + xpDidapat;
            Swal.fire({ title: 'Benar!', icon: 'success', timer: 1000, showConfirmButton: false, position: 'top' });
        } else {
            playSfx('error');
            const kunciStr = Array.isArray(data.kunci) ? data.kunci.join(" ") : data.kunci;
            Swal.fire({ title: 'Kurang Tepat', text: `Jawaban: ${JSON.stringify(data.kunci)}`, icon: 'error', confirmButtonColor: '#ef4444' });
        }
        soalSekarang++; setTimeout(muatSoal, 1200);
    };

    async function levelSelesai() {
        playSfx('selesai');
        if (currentUser && xpDidapat > 0) {
            const ref = doc(db, "users", currentUser.uid);
            try {
                const snap = await getDoc(ref);
                const lama = snap.data();
                let update = { total_xp: (lama.total_xp||0) + xpDidapat };
                const progLama = lama[DB_FIELD] || 1;
                if (levelId >= progLama) { update[DB_FIELD] = levelId + 1; }
                await updateDoc(ref, update);
            } catch (e) { console.error(e); }
        }
        Swal.fire({ title: 'Selesai!', html: `Level ${levelId} Tuntas!<br>+${xpDidapat} XP`, icon: 'success', confirmButtonText: 'Lanjut', confirmButtonColor: '#2563eb', allowOutsideClick: false }).then(() => { window.location.href = BACK_LINK; });
    }

    window.keluarGame = () => { Swal.fire({ title: 'Keluar?', text: "Poin hilang.", icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya' }).then(r => { if(r.isConfirmed) window.location.href = BACK_LINK }); };
</script>
</body>
</html>